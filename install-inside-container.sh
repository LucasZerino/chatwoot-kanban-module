#!/bin/sh

# ========================================================================
# INSTALADOR DO M√ìDULO KANBAN - EXECU√á√ÉO DENTRO DO CONTAINER
# ========================================================================
# Este script deve ser executado DENTRO do container Rails
# Via Portainer Console ou docker exec
# ========================================================================

set -e

echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "üöÄ INSTALADOR DO M√ìDULO KANBAN (Dentro do Container)"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

# URL do m√≥dulo no GitHub
MODULE_URL="${KANBAN_MODULE_URL:-https://github.com/LucasZerino/chatwoot-kanban-module/releases/download/kanban/kanban-module.tar.gz}"

# Verificar se j√° foi instalado
if [ -f "/app/.kanban-installed" ]; then
  echo "‚ö†Ô∏è  M√≥dulo Kanban j√° instalado"
  echo "   Para reinstalar, execute: rm /app/.kanban-installed"
  exit 0
fi

# ========================================================================
# INSTALAR FERRAMENTAS NECESS√ÅRIAS
# ========================================================================
echo "üì¶ Instalando ferramentas..."

# Instalar curl/wget se n√£o existir
if ! command -v wget >/dev/null 2>&1 && ! command -v curl >/dev/null 2>&1; then
  echo "   Instalando wget..."
  apk add --no-cache wget 2>/dev/null || apt-get update && apt-get install -y wget 2>/dev/null || true
fi

# Instalar pnpm se n√£o existir
if ! command -v pnpm >/dev/null 2>&1; then
  echo "   Instalando pnpm..."
  if ! command -v npm >/dev/null 2>&1; then
    apk add --no-cache nodejs npm 2>/dev/null || apt-get install -y nodejs npm 2>/dev/null || true
  fi
  npm install -g pnpm 2>/dev/null || true
fi

echo "‚úÖ Ferramentas instaladas"
echo ""

# ========================================================================
# BAIXAR M√ìDULO
# ========================================================================
echo "üì• Baixando m√≥dulo do GitHub..."
echo "   URL: $MODULE_URL"

cd /tmp

if command -v wget >/dev/null 2>&1; then
  wget -q -O kanban-module.tar.gz "$MODULE_URL"
elif command -v curl >/dev/null 2>&1; then
  curl -sL -o kanban-module.tar.gz "$MODULE_URL"
else
  echo "‚ùå Erro: wget ou curl n√£o encontrado"
  exit 1
fi

if [ ! -f "kanban-module.tar.gz" ] || [ ! -s "kanban-module.tar.gz" ]; then
  echo "‚ùå Erro: Falha ao baixar o m√≥dulo"
  exit 1
fi

echo "‚úÖ M√≥dulo baixado ($(du -h kanban-module.tar.gz | cut -f1))"
echo ""

# ========================================================================
# EXTRAIR M√ìDULO
# ========================================================================
echo "üì¶ Extraindo m√≥dulo..."

tar -xzf kanban-module.tar.gz -C /tmp
rm -rf /app/kanban-module
mv /tmp/kanban-module /app/

echo "‚úÖ M√≥dulo extra√≠do em /app/kanban-module"
echo ""

# ========================================================================
# COPIAR ARQUIVOS
# ========================================================================
echo "üìÇ Copiando arquivos do m√≥dulo..."

# Copiar controllers
echo "   ‚Üí Controllers..."
cp -r /app/kanban-module/controllers/* /app/app/controllers/api/v1/accounts/ 2>/dev/null || true

# Copiar models
echo "   ‚Üí Models..."
cp -r /app/kanban-module/models/* /app/app/models/ 2>/dev/null || true

# Copiar helpers
echo "   ‚Üí Helpers..."
mkdir -p /app/app/helpers/api/v1/accounts/kanban
cp -r /app/kanban-module/helpers/kanban/* /app/app/helpers/api/v1/accounts/kanban/ 2>/dev/null || true

# Copiar serializers
echo "   ‚Üí Serializers..."
cp -r /app/kanban-module/serializers/* /app/app/serializers/ 2>/dev/null || true

# Copiar policies
echo "   ‚Üí Policies..."
cp -r /app/kanban-module/policies/* /app/app/policies/ 2>/dev/null || true

# Copiar views
echo "   ‚Üí Views..."
mkdir -p /app/app/views/api/v1/accounts/{products,kanban_cards/products,conversations/products,conversations/funnels,conversations/followers}
cp /app/kanban-module/views/products/*.jbuilder /app/app/views/api/v1/accounts/products/ 2>/dev/null || true
cp /app/kanban-module/views/kanban_cards/products/*.jbuilder /app/app/views/api/v1/accounts/kanban_cards/products/ 2>/dev/null || true
cp /app/kanban-module/views/conversations/products/*.jbuilder /app/app/views/api/v1/accounts/conversations/products/ 2>/dev/null || true
cp /app/kanban-module/views/conversations/funnels/*.jbuilder /app/app/views/api/v1/accounts/conversations/funnels/ 2>/dev/null || true
cp /app/kanban-module/views/conversations/followers/*.jbuilder /app/app/views/api/v1/accounts/conversations/followers/ 2>/dev/null || true

# Copiar services
echo "   ‚Üí Services..."
cp -r /app/kanban-module/services/* /app/app/services/ 2>/dev/null || true

# Copiar frontend
echo "   ‚Üí Frontend routes..."
mkdir -p /app/app/javascript/dashboard/routes/dashboard/kanban
cp -r /app/kanban-module/frontend/routes/dashboard/kanban/* /app/app/javascript/dashboard/routes/dashboard/kanban/ 2>/dev/null || true
mkdir -p /app/app/javascript/dashboard/routes/dashboard/settings/products
cp -r /app/kanban-module/frontend/routes/settings/products/* /app/app/javascript/dashboard/routes/dashboard/settings/products/ 2>/dev/null || true
mkdir -p /app/app/javascript/dashboard/routes/dashboard/settings/notifications
cp /app/kanban-module/frontend/routes/settings/notifications/KanbanNotificationSettings.vue /app/app/javascript/dashboard/routes/dashboard/settings/notifications/ 2>/dev/null || true

echo "   ‚Üí Frontend store..."
cp -r /app/kanban-module/frontend/store/modules/* /app/app/javascript/dashboard/store/modules/ 2>/dev/null || true

echo "   ‚Üí Frontend API..."
cp -r /app/kanban-module/frontend/api/* /app/app/javascript/dashboard/api/ 2>/dev/null || true

echo "   ‚Üí Frontend composables..."
cp -r /app/kanban-module/frontend/composables/* /app/app/javascript/dashboard/composables/ 2>/dev/null || true

echo "   ‚Üí Frontend components..."
cp /app/kanban-module/frontend/components/conversation/ConversationFunnels.vue /app/app/javascript/dashboard/routes/dashboard/conversation/ 2>/dev/null || true
mkdir -p /app/app/javascript/dashboard/components-next/Contacts/ContactsSidebar
cp /app/kanban-module/frontend/components/contacts/ContactProducts.vue /app/app/javascript/dashboard/components-next/Contacts/ContactsSidebar/ 2>/dev/null || true
mkdir -p /app/app/javascript/dashboard/components/widgets
cp /app/kanban-module/frontend/components/widgets/AutomationFunnelColumnInput.vue /app/app/javascript/dashboard/components/widgets/ 2>/dev/null || true
mkdir -p /app/app/javascript/dashboard/components-next/Conversation/ConversationCard
cp /app/kanban-module/frontend/components/conversation-card/CardFunnels.vue /app/app/javascript/dashboard/components-next/Conversation/ConversationCard/ 2>/dev/null || true
cp /app/kanban-module/frontend/components/conversation-card/CardFunnel.vue /app/app/javascript/dashboard/components-next/Conversation/ConversationCard/ 2>/dev/null || true

echo "   ‚Üí Frontend i18n..."
cp -r /app/kanban-module/frontend/i18n/locale/en/*.json /app/app/javascript/dashboard/i18n/locale/en/ 2>/dev/null || true
cp -r /app/kanban-module/frontend/i18n/locale/pt_BR/*.json /app/app/javascript/dashboard/i18n/locale/pt_BR/ 2>/dev/null || true

# Copiar migrations
echo "   ‚Üí Migrations..."
cp /app/kanban-module/migrations/* /app/db/migrate/ 2>/dev/null || true

# Copiar Sidebar.vue
echo "   ‚Üí Sidebar.vue..."
cp /app/kanban-module/frontend/components/sidebar/Sidebar.vue /app/app/javascript/dashboard/components-next/sidebar/Sidebar.vue 2>/dev/null || true

echo "‚úÖ Arquivos copiados"
echo ""

# ========================================================================
# APLICAR PATCHES
# ========================================================================
echo "üîß Aplicando patches..."

if [ -d "/app/kanban-module/patches" ]; then
  cd /app/kanban-module/patches
  chmod +x *.sh *.rb 2>/dev/null || true
  sh apply-patches.sh 2>/dev/null || echo "‚ö†Ô∏è  Alguns patches j√° aplicados"
fi

# Patch: Adicionar rotas do Kanban no dashboard.routes.js
echo "üîß Aplicando patch de rotas do Kanban..."
DASHBOARD_ROUTES="/app/app/javascript/dashboard/routes/dashboard/dashboard.routes.js"
if ! grep -A 20 "children: \[" "$DASHBOARD_ROUTES" | grep -q "...kanbanRoutes"; then
  sed -i '/...campaignsRoutes.routes,/a\        ...kanbanRoutes,' "$DASHBOARD_ROUTES"
  echo "  ‚úÖ Rotas do Kanban adicionadas"
else
  echo "  ‚è≠Ô∏è  Rotas do Kanban j√° adicionadas"
fi

# Patch: Adicionar rotas de produtos no settings.routes.js
echo "üîß Aplicando patch de rotas de produtos..."
SETTINGS_ROUTES="/app/app/javascript/dashboard/routes/dashboard/settings/settings.routes.js"
if ! grep -q "import products from" "$SETTINGS_ROUTES"; then
  sed -i "/import reports from/a\import products from './products/products.routes';" "$SETTINGS_ROUTES"
  sed -i '/...reports.routes,/a\    ...products.routes,' "$SETTINGS_ROUTES"
  echo "  ‚úÖ Rotas de produtos adicionadas"
else
  echo "  ‚è≠Ô∏è  Rotas de produtos j√° adicionadas"
fi

# Patch: Adicionar tradu√ß√µes do Kanban no i18n EN
echo "üîß Aplicando patch de tradu√ß√µes EN..."
I18N_EN="/app/app/javascript/dashboard/i18n/locale/en/index.js"
if ! grep -q "import kanban from" "$I18N_EN"; then
  sed -i "/import mfa from/a\import kanban from './kanban.json';" "$I18N_EN"
  sed -i "/import kanban from/a\import productsMgmt from './productsMgmt.json';" "$I18N_EN"
  sed -i '/...mfa,/a\  ...kanban,' "$I18N_EN"
  sed -i '/...kanban,/a\  ...productsMgmt,' "$I18N_EN"
  echo "  ‚úÖ Tradu√ß√µes EN adicionadas"
else
  echo "  ‚è≠Ô∏è  Tradu√ß√µes EN j√° adicionadas"
fi

# Patch: Adicionar tradu√ß√µes do Kanban no i18n PT-BR
echo "üîß Aplicando patch de tradu√ß√µes PT-BR..."
I18N_PT="/app/app/javascript/dashboard/i18n/locale/pt_BR/index.js"
if ! grep -q "import kanban from" "$I18N_PT"; then
  sed -i "/import whatsappTemplates from/a\import kanban from './kanban.json';" "$I18N_PT"
  sed -i "/import kanban from/a\import productsMgmt from './productsMgmt.json';" "$I18N_PT"
  sed -i '/...whatsappTemplates,/a\  ...kanban,' "$I18N_PT"
  sed -i '/...kanban,/a\  ...productsMgmt,' "$I18N_PT"
  echo "  ‚úÖ Tradu√ß√µes PT-BR adicionadas"
else
  echo "  ‚è≠Ô∏è  Tradu√ß√µes PT-BR j√° adicionadas"
fi

# Patch: Registrar m√≥dulos no store
echo "üîß Aplicando patch de store modules..."
STORE_INDEX="/app/app/javascript/dashboard/store/index.js"
if ! grep -q "import products from './modules/products'" "$STORE_INDEX"; then
  sed -i "/import portals from/a\import products from './modules/products';" "$STORE_INDEX"
  sed -i "/import products from/a\import conversationProducts from './modules/conversationProducts';" "$STORE_INDEX"
  sed -i "/import conversationProducts from/a\import kanbanCardProducts from './modules/kanbanCardProducts';" "$STORE_INDEX"
  sed -i "/import kanbanCardProducts from/a\import conversationFunnels from './modules/conversationFunnels';" "$STORE_INDEX"
  sed -i '/    portals,/a\    products,' "$STORE_INDEX"
  sed -i '/    products,/a\    conversationProducts,' "$STORE_INDEX"
  sed -i '/    conversationProducts,/a\    kanbanCardProducts,' "$STORE_INDEX"
  sed -i '/    kanbanCardProducts,/a\    conversationFunnels,' "$STORE_INDEX"
  echo "  ‚úÖ Store modules registrados"
else
  echo "  ‚è≠Ô∏è  Store modules j√° registrados"
fi

# Patch: Copiar mutation-types.js
echo "üîß Copiando mutation-types.js atualizado..."
if [ -f "/app/kanban-module/frontend/mutation-types.js" ]; then
  cp /app/kanban-module/frontend/mutation-types.js /app/app/javascript/dashboard/store/mutation-types.js
  echo "  ‚úÖ Mutation types atualizados"
else
  echo "  ‚è≠Ô∏è  mutation-types.js n√£o encontrado no m√≥dulo"
fi

echo "‚úÖ Patches aplicados"
echo ""

# ========================================================================
# EXECUTAR MIGRATIONS
# ========================================================================
echo "üóÑÔ∏è  Executando migrations..."

cd /app
bundle exec rails db:migrate 2>/dev/null || echo "‚ö†Ô∏è  Migrations j√° executadas"

echo "‚úÖ Migrations executadas"
echo ""

# ========================================================================
# INSTALAR DEPEND√äNCIAS E COMPILAR ASSETS
# ========================================================================
echo "üì¶ Instalando depend√™ncias frontend..."

cd /app
pnpm install --frozen-lockfile 2>/dev/null || pnpm install

echo "‚úÖ Depend√™ncias instaladas"
echo ""

echo "üßπ Limpando cache de assets antigos..."

# Limpar cache antigo para for√ßar rebuild completo
rm -rf public/packs public/vite tmp/cache/assets tmp/cache/webpacker 2>/dev/null || true

echo "‚úÖ Cache limpo"
echo ""

echo "üèóÔ∏è  Compilando assets (isso pode demorar 1-2 minutos)..."

# Compilar com flags para for√ßar rebuild completo
RAILS_ENV=production NODE_ENV=production bundle exec rake assets:clobber assets:precompile

echo "‚úÖ Assets compilados"
echo ""

# ========================================================================
# MARCAR COMO INSTALADO
# ========================================================================
touch /app/.kanban-installed

# Limpar tempor√°rios
rm -f /tmp/kanban-module.tar.gz

echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "‚úÖ INSTALA√á√ÉO CONCLU√çDA!"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""
echo "üéØ PR√ìXIMOS PASSOS:"
echo "   1. Reinicie o container Rails"
echo "   2. Acesse seu Chatwoot"
echo "   3. Pressione Ctrl+Shift+R para limpar cache"
echo "   4. Procure 'Kanban' no menu lateral"
echo ""
echo "‚ö†Ô∏è  IMPORTANTE: Reinicie o container para aplicar as mudan√ßas!"
echo ""

